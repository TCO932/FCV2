# Form implementation generated from reading ui file 'qtUI/machineWidget.ui'
#
# Created by: PyQt6 UI code generator 6.7.1
#
# WARNING: Any manual changes made to this file will be lost when pyuic6 is
# run again.  Do not edit this file unless you know what you are doing.


from dataclasses import dataclass
from PyQt6 import QtCore, QtGui, QtWidgets
from classes import EffectedMachine, Machine, Module

from data import MACHINES, MODULES
from widgets.DraggableModuleWidget import DraggableModule, ModuleDropSlot


class MachineWidget(QtWidgets.QWidget):
    calculateClicked = QtCore.pyqtSignal(EffectedMachine)

    def __init__(self):
        super().__init__()
        self.setupUi()

        for machine in MACHINES.values():
            self.selectMachine.addItem(machine.getFormattedName(), machine) 

        self.selectMachine.currentIndexChanged.connect(self.on_machine_changed)
        
        self.calculateButton.pressed.connect(self.on_calculate_button)


    def setModel(self, effectedMachine: EffectedMachine, noProd: bool = False):
        self.effectedMachine = effectedMachine

        self.modules = MODULES['speed']
        if noProd == False:
            self.modules.update(MODULES['prod'])

        for module in self.modules.values():
            draggableModule = DraggableModule(module)
            self.modulesLayout.addWidget(draggableModule)

        self.selectedModules = []
        if effectedMachine.modules:
            self.selectedModules = effectedMachine.modules

        self.modulesSlots = [ModuleDropSlot(module) for module in self.selectedModules]
        for slot in self.modulesSlots:
            self.modulesSlotsLayout.addWidget(slot)

        self.numberOfBeaconsSpinBox.setValue(effectedMachine.beaconsNumber)
        self.select_machine(effectedMachine)


    # TODO use in future
    def addToSlots(self, module: Module):
        for slot in self.modulesSlots:
            if slot.module is None:
                slot.setData(module)


    def select_machine(self, machine: Machine):
        for index in range(self.selectMachine.count()):
            if self.selectMachine.itemData(index).name == machine.name:
                self.selectMachine.setCurrentIndex(index)
                return

    def on_machine_changed(self, index):
        machine: Machine = self.selectMachine.itemData(index)
        self.numberOfBeaconsSpinBox.setRange(0, machine.maxBeacons)

        for i, slot in enumerate(self.modulesSlots):
            if i+1 > machine.slots:
                slot.hide()


        # while len of shown slots less than machine slots
        while len(list(filter(lambda slot: not slot.isHidden(), self.modulesSlots))) < machine.slots:
            hiddenSlots = list(filter(lambda slot: slot.isHidden(), self.modulesSlots))
            if hiddenSlots:
                hiddenSlots[0].show()
            else:
                slot = ModuleDropSlot()
                self.modulesSlotsLayout.addWidget(slot)


        print(f"Выбранная машина: {machine}")

    def on_calculate_button(self):
        modules = []
        for slot in self.modulesSlots:
            if slot.module is not None and not slot.isHidden():
                modules.append(slot.module)

        effectedMachine = EffectedMachine.fromMachine(
            self.selectMachine.currentData(),
            modules=modules,
            beaconsNumber=self.numberOfBeaconsSpinBox.value()
        )
        self.calculateClicked.emit(effectedMachine)

    def setupUi(self):
        self.setObjectName("MachineWidget")
        self.resize(250, 300)
        self.verticalLayout = QtWidgets.QVBoxLayout(self)
        self.verticalLayout.setObjectName("verticalLayout")
        self.selectMachineLabel = QtWidgets.QLabel(parent=self)
        sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Policy.Preferred, QtWidgets.QSizePolicy.Policy.Fixed)
        sizePolicy.setHorizontalStretch(0)
        sizePolicy.setVerticalStretch(0)
        sizePolicy.setHeightForWidth(self.selectMachineLabel.sizePolicy().hasHeightForWidth())
        self.selectMachineLabel.setSizePolicy(sizePolicy)
        self.selectMachineLabel.setObjectName("selectMachineLabel")
        self.verticalLayout.addWidget(self.selectMachineLabel)
        self.selectMachine = QtWidgets.QComboBox(parent=self)
        self.selectMachine.setObjectName("selectMachine")
        self.verticalLayout.addWidget(self.selectMachine)

        # Module layout
        self.ModulesLabel = QtWidgets.QLabel(parent=self)
        sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Policy.Preferred, QtWidgets.QSizePolicy.Policy.Fixed)
        sizePolicy.setHorizontalStretch(0)
        sizePolicy.setVerticalStretch(0)
        sizePolicy.setHeightForWidth(self.ModulesLabel.sizePolicy().hasHeightForWidth())
        self.ModulesLabel.setSizePolicy(sizePolicy)
        self.ModulesLabel.setObjectName("selectModuleLabel")
        self.verticalLayout.addWidget(self.ModulesLabel)

        self.modulesLayout = QtWidgets.QHBoxLayout()
        self.modulesLayout.setObjectName("selectModule")
        self.modulesLayout.setAlignment(QtCore.Qt.AlignmentFlag.AlignLeft)
        self.verticalLayout.addLayout(self.modulesLayout)

        self.modulesSlotsLayout = QtWidgets.QHBoxLayout()
        self.modulesSlotsLayout.setObjectName("modulesSlots")
        self.modulesSlotsLayout.setAlignment(QtCore.Qt.AlignmentFlag.AlignLeft)
        self.verticalLayout.addLayout(self.modulesSlotsLayout)

        # end Module layout


        self.numberOfModulesLabel = QtWidgets.QLabel(parent=self)
        sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Policy.Preferred, QtWidgets.QSizePolicy.Policy.Fixed)
        sizePolicy.setHorizontalStretch(0)
        sizePolicy.setVerticalStretch(0)
        sizePolicy.setHeightForWidth(self.numberOfModulesLabel.sizePolicy().hasHeightForWidth())
        self.numberOfModulesLabel.setSizePolicy(sizePolicy)
        self.numberOfModulesLabel.setObjectName("numberOfModulesLabel")
        self.verticalLayout.addWidget(self.numberOfModulesLabel)
        self.numberOfModulesSpinBox = QtWidgets.QSpinBox(parent=self)
        self.numberOfModulesSpinBox.setObjectName("numberOfModulesSpinBox")
        self.verticalLayout.addWidget(self.numberOfModulesSpinBox)
        self.numberOfBeaconsLabel = QtWidgets.QLabel(parent=self)
        sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Policy.Preferred, QtWidgets.QSizePolicy.Policy.Fixed)
        sizePolicy.setHorizontalStretch(0)
        sizePolicy.setVerticalStretch(0)
        sizePolicy.setHeightForWidth(self.numberOfBeaconsLabel.sizePolicy().hasHeightForWidth())
        self.numberOfBeaconsLabel.setSizePolicy(sizePolicy)
        self.numberOfBeaconsLabel.setObjectName("numberOfBeaconsLabel")
        self.verticalLayout.addWidget(self.numberOfBeaconsLabel)
        self.numberOfBeaconsSpinBox = QtWidgets.QSpinBox(parent=self)
        self.numberOfBeaconsSpinBox.setObjectName("numberOfBeaconsSpinBox")
        self.verticalLayout.addWidget(self.numberOfBeaconsSpinBox)
        self.calculateButton = QtWidgets.QPushButton(parent=self)
        self.calculateButton.setObjectName("calculateButton")
        self.verticalLayout.addWidget(self.calculateButton)

        self.retranslateUi(self)
        QtCore.QMetaObject.connectSlotsByName(self)

    def retranslateUi(self, MachineWidget: QtWidgets.QWidget):
        _translate = QtCore.QCoreApplication.translate
        MachineWidget.setWindowTitle(_translate("MachineWidget", "Form"))
        self.selectMachineLabel.setText(_translate("MachineWidget", "Machine:"))
        self.ModulesLabel.setText(_translate("MachineWidget", "Module:"))
        self.numberOfModulesLabel.setText(_translate("MachineWidget", "Number of Modules:"))
        self.numberOfBeaconsLabel.setText(_translate("MachineWidget", "Number of Beacons"))
        self.calculateButton.setText(_translate("MachineWidget", "Calculate"))


if __name__ == "__main__":
    import sys
    app = QtWidgets.QApplication(sys.argv)
    machineWidget = MachineWidget()
    machineWidget.show()
    sys.exit(app.exec())
